---
title: "A reskit test document, if you will"
lightbox: true
knitr:
  opts_chunk:
    message: false
---

### Load the package

```{r}

devtools::load_all(here::here())

```

### Get some results data

```{r results path}
#| eval: false
res_con <- get_results_container()

# these should do the same thing
res_path1 <- get_results_folder_path("v4.2", "RCX", container = res_con)
res_path2 <- get_results_folder_path(
  "v4.2",
  "RCX",
  "test-md-v42",
  container = res_con
)
# check:
identical(res_path1, res_path2)


results <- read_results_parquet_files(res_path1, container = res_con)
readr::write_rds(results, here::here("test_results.rds"))

```

Yay that worked.

Now to read in the results data.
I am not sure which tables I will end up needing for the outputs plots and
tables so for now I will just return all of them (this is the default behaviour
for `read_results_parquet_files()`).

And let's have a peek at the `default` results table.

```{r results in}
results <- readr::read_rds(here::here("test_results.rds"))
tibble::glimpse(results[["default"]])

```


## "Principal projection: summary" table (Summary by point of delivery)

We can see from the nhp_outputs repo that the principal projection summary
(by point of delivery) table is generated by:

```r
selected_data() |>
  mod_principal_summary_data(selected_site())

```

`mod_principal_summary_data()` is currently known in {reskit} as
~`compile_principal_summary_data()`~ `compile_principal_pod_data()`.

We need to supply a vector of sites to the function, but if we look at
`trust_site_aggregation()`, which is where the `sites` parameter actually comes
into play, a NULL sites list will just result in no filtering (all sites).

We now have a `make_main_summary_table()` function that works, generating the
main summary table as expected:

```{r corrected attempt at compile_main_summary_data}
#| eval: false
results |>
  purrr::pluck("default") |>
  # summarise_to_selected_sites(NULL) |>
  compile_main_summary_data() |>
  make_main_summary_table()

```


However, we need to make sure we are not "prematurely optimising" our data
pipeline.

There is more than one use case for these reskit functions, not just to generate
tables and plots.
But for example we need to allow users to export data tables in Excel format.
These can be relatively "raw" versions of the data tables, but they do need to
have had some processing, such as the conversion from model runs to a baseline
and principal figure.

So we can try to construct a logical flow for the data (generically, not related
to a specific table - there may be some exceptions):

1. initial table read in
1. selection of columns and any initial filtering
1. calculation of baseline and principal and change/pct
1. table ready to export to Excel at this stage
1. filter to selected sites, if any
1. any other preparations required before producing tables/plots
1. (the above step could potentially be moved to the table/plot functions)


Having refactored the above pathway slightly, we can now give ourselves the
option to export a site-level summary of the data (designed to be exported to
CSV/xlsx), before proceeding to calculate overall summary figures for the scheme
as a whole (across all sites) and adding on the calculated Change and Percent
Change columns.

At this point the data is pretty much ready to used to generate the table we
need for our reporting.

This is `mod_principal_summary_data()` in nhp_outputs.

```{r main pod table process}
results |>
  purrr::pluck("default") |>
  compile_principal_pod_data() |>
  make_principal_pod_table()

```



```{r sites}

sites <- get_trust_sites(results[["default"]])

```


## Principal projection: length of stay summary tables

### Bed days summary by length of stay and point of delivery

This is `mod_principal_summary_los_table()` in nhp_outputs, with
different inputs: `summary_los_data_beddays()` and
`summary_los_data_admissions()`



```{r make los summary table 1}
results |>
  purrr::pluck("tretspef+los_group") |>
  compile_principal_los_data(measure = "beddays") |>
  make_principal_los_table()

```


### Admissions summary by length of stay and point of delivery

```{r make los summary table 2}
results |>
  purrr::pluck("tretspef+los_group") |>
  compile_principal_los_data(measure = "admissions") |>
  make_principal_los_table()

```


### Impact of changes charts

```{r change factors plot 1}
step_counts_tbl <- results[["step_counts"]]

prepared_data <- prepare_principal_change_factor_data(step_counts_tbl, TRUE)

activity_types <- unique(prepared_data[["activity_type_label"]])
pods <- unique(prepared_data[["pod_label"]])
measures <- unique(prepared_data[["measure"]])

set.seed(21879)
activity_type <- sample(activity_types, 1)
measure <- sample(measures, 1)

interim_data <- prepared_data |>
  filter_to_selected_sites(sites = NULL) |>
  summarise_for_all_sites() |>
  filter_principal_change_factor_data(activity_type, pods, measure) |>
  dplyr::summarise(dplyr::across("value", sum), .by = "change_factor") |>
  # Here we need to sort by decreasing value (biggest increases in activity
  # (positive 'value's) at the top), and we need to ensure that the 'baseline'
  # row is at the top so that the cumsum() step works correctly.
  dplyr::arrange(dplyr::desc(dplyr::pick("value"))) |>
  move_baseline_row_to_top() |>
  dplyr::mutate(
    cmvalue = cumsum(.data[["value"]]),
    hidden = dplyr::lag(.data[["cmvalue"]], 1, 0) + pmin(.data[["value"]], 0),
    total = abs(.data[["value"]]) + .data[["hidden"]]
  ) |>
  dplyr::select(!"cmvalue")

estimate_row <- tibble::tibble_row(
  change_factor = "estimate",
  value = sum(interim_data[["value"]]),
  hidden = 0,
  total = .data[["value"]]
)

interim_data |>
  dplyr::bind_rows(estimate_row) |>
  dplyr::mutate(dplyr::across("change_factor", forcats::fct_inorder)) |>
  make_overall_cf_plot()

```


## Activity in detail table

```{r activity in detail table}
#| eval: false
results |>
  compile_detailed_activity_data() |>
  # summarise_to_selected_sites(NULL) |>
  filter_detailed_activity_data(
    "age_group",
    "ip",
    "ip_elective_admission",
    "admissions"
  )

```
